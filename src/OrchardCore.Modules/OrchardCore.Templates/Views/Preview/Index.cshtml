@{
    Layout = null;
    Title.AddSegment(T["Template Preview"]);
}

<style asp-name="bootstrap" use-cdn="true"></style>
<script asp-name="bootstrap" use-cdn="true" at="Foot"></script>
<script asp-src="/OrchardCore.Templates/js.cookie.js" depends-on="jquery" at="Foot"></script>

<resources type="Header" />

<iframe id="iframe" style="position:fixed; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;">
    Your browser doesn't support iframes
</iframe>

<div id="notConnectedWarning" class="alert alert-info alert-dismissible fade show collapse" role="alert" style="position:fixed; height:60px; top:10px;right:40px; display:none; z-index:999999;">
    <button type="button" id="close-warning" class="close" aria-label="Close" style="position: relative; padding: 0 0 0 1rem; margin-top: -0.2rem;">
        <span aria-hidden="true">&times;</span>
    </button>
    <span>@T["Preview Disconnected"] </span>
</div>

<resources type="Footer" />

<div id="renderPreviewUrl" style="display:none" data-value="@Url.Content("~/")"></div>

<script type="text/javascript">
    var renderPreviewUrl = $(document.getElementById('renderPreviewUrl')).data('value');

    $(function () {
        $(window).on('storage', function (ev) {
            if (ev.key == 'OrchardCore.templates:not-connected') {
                $(notConnectedWarning).show();
            }
            else if (ev.key == 'OrchardCore.templates') {
                if (ev.originalEvent.newValue != null) {
                    $(notConnectedWarning).hide();
                    renderPreview(ev.originalEvent.newValue);
                }
            }
        });

        // override default behaviour of Bootstrap's. We only hide, not remove the alert.
        $('#close-warning').on('click', function () {
            $('#notConnectedWarning').hide();
        });

        var preview = localStorage.getItem('OrchardCore.templates');

        if (preview == null) {
            // notify the editor to render the preview
            localStorage.setItem('OrchardCore.templates:ready', '');
            localStorage.removeItem('OrchardCore.templates:ready');
        }
        else {
            renderPreview(preview);
        }
    });

    var iframe = document.getElementById('iframe');
    var notConnectedWarning = document.getElementById('notConnectedWarning');

    iframe.onload = function () {
        renderPreviewUrl = this.contentWindow.location;
        $(iframe.contentWindow).scrollTop(scrollTop);

        var count = Cookies.get('orchard:templates:count');
        Cookies.remove("orchard:templates:count", { path: "/" });
        for (i = 0; i < count; i++) {
            Cookies.remove("orchard:templates:" + i, { path: "/" });
        }
    }

    var scrollTop;
    var rendering;

    function renderPreview(value) {

        renderRequested = true;

        // Squashes all event calls into one
        if (rendering) {
            return;
        }

        // Pump renderPreview calls
        while (renderRequested) {
            renderRequested = false;
            rendering = true;
            try {
                var formData = value;
                if (!formData) return;

                var encoded = window.btoa(unescape(encodeURIComponent(formData)));

                var chunks = Math.floor(encoded.length / 1364) + 1;
                Cookies.set("orchard:templates:count", chunks, { path: "/" });

                for (i = 0; i < chunks; i++) {
                    var chunk = encoded.slice(i * 1364, (i + 1) * 1364);
                    Cookies.remove("orchard:templates:" + i, { path: "/" });
                    Cookies.set("orchard:templates:" + i, chunk, { path: "/" });
                }

                scrollTop = $(iframe.contentWindow).scrollTop();
                iframe.contentWindow.location = renderPreviewUrl;
            }
            catch (e) {
                console.error('Error while previewing: ' + e);
            }
            finally {
                rendering = false;
            }
        }
    }

</script>