var WorkflowEditor=function(){return function(t,i,o){var n=this;this.container=t,this.serialize=function(){for(var t=$(this.container).find(".activity"),i={activities:[],transitions:[]},o=0;o<t.length;o++){var n=$(t[o]),e=n.data("activity-id"),a=n.data("activity-start"),r=n.position();i.activities.push({id:e,isStart:a,x:r.left,y:r.top})}var c=this.jsPlumbInstance.getConnections();for(o=0;o<c.length;o++){var s=c[o],d=s.endpoints[0].getParameters().outcome.name,l=$(s.source).data("activity-id"),u=$(s.target).data("activity-id");i.transitions.push({sourceActivityId:l,destinationActivityId:u,sourceOutcomeName:d})}return JSON.stringify(i)},jsPlumb.ready(function(){var e=jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:t});e.bind("connection",function(t,i){var o=t.connection,n=o.getParameters().outcome;o.getOverlay("label").setLabel(n.displayName)});var a=$(t).find(".activity");e.batch(function(){var t=i,o=t.id;a.each(function(i,o){var n=$(o).data("activity-id");e.draggable(o,{grid:[10,10]}),e.makeTarget(o,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(var a=$.grep(t.activities,function(t){return t.id==n})[0],r=(a.outcomes.length,0),c=a.outcomes;r<c.length;r++){var s=c[r],d=(l=a,u=s,{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:"#7AB02C",fill:"#7AB02C",radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},dragOptions:{},overlays:[["Label",{location:[.5,1.5],cssClass:"endpointSourceLabel",visible:!0}]],uuid:l.id+"-"+u.name,parameters:{outcome:u}});e.addEndpoint(o,d)}var l,u});for(var n=0,r=t.transitions;n<r.length;n++){var c=r[n],s=c.sourceActivityId+"-"+c.sourceOutcomeName,d=e.getEndpoint(s),l="activity-"+o+"-"+c.destinationActivityId;e.connect({source:d,target:l})}e.bind("contextmenu",function(t,i){}),e.bind("connectionDrag",function(t){console.log("connection "+t.id+" is being dragged. suspendedElement is ",t.suspendedElement," of type ",t.suspendedElementType)}),e.bind("connectionDragStop",function(t){console.log("connection "+t.id+" was dragged")}),e.bind("connectionMoved",function(t){console.log("connection "+t.connection.id+" was moved")})}),a.popover({trigger:"manual",html:!0,content:function(){var t=$(this),i=t.find(".activity-commands").clone().show(),n=i.find(".activity-start-action"),a=!0===t.data("activity-start");return n.attr("aria-pressed",t.data("activity-start")),n.toggleClass("active",a),i.on("click",".activity-start-action",function(i){i.preventDefault();var o=$(i.currentTarget);o.button("toggle");var n=o.is(".active");t.data("activity-start",n),t.toggleClass("activity-start",n)}),i.on("click",".activity-delete-action",function(i){i.preventDefault(),confirm(o)&&(e.remove(t),t.popover("dispose"))}),i.get(0)}}),$(t).on("click",".activity",function(t){n.isDragging||(n.isPopoverVisible&&a.popover("hide"),$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",function(t){t.stopPropagation()}),t.stopPropagation(),n.isPopoverVisible=!0)}),$(t).on("dblclick",".activity",function(t){$(t.currentTarget).find(".activity-edit-action").get(0).click()}),$("body").on("click",function(t){a.popover("hide"),n.isPopoverVisible=!1}),n.jsPlumbInstance=e})}}();$.fn.workflowEditor=function(){return this.each(function(t,i){var o=$(i),n=o.data("workflow-definition"),e=o.data("workflow-delete-activity-prompt");o.data("workflowEditor",new WorkflowEditor(i,n,e))}),this},$(document).ready(function(){var t=$(".workflow-editor-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",function(i,o){var n=t.serialize();$("#workflowStateInput").val(n)})});
