tinymce.PluginManager.add('orchardcoremedia', function (editor, url) {
  var openDialog = function () {
    $("#mediaApp").detach().appendTo('#mediaModalHtmlField .modal-body');
    $("#mediaApp").show();
    mediaApp.selectedMedias = [];
    var modal = $('#mediaModalHtmlField').modal();
    $('#mediaHtmlFieldSelectButton').on('click', function (v) {
      
      $(window).trigger('scroll');

      for (i = 0; i < mediaApp.selectedMedias.length; i++) {
        //var img = document.createElement("img");
        //img.src = mediaApp.selectedMedias[i].url; 
        //img.alt = mediaApp.selectedMedias[i].name;
        //editor.insertContent(img);
        editor.insertContent("<img src='"+mediaApp.selectedMedias[i].url+"' alt='"+mediaApp.selectedMedias[i].name+"'/>");
      }

      //editor.eve;
      //editor.focus();

      $('#mediaModalHtmlField').modal('hide');
      return true;
    });
  };

  // Add a button that opens window
  editor.ui.registry.addButton('orchardcoremedia', {
    tooltip: 'Orchard Core Media Assets',
    icon: 'image',
    onAction: function () {
      // Open window
      openDialog();
    }
  });

  // Adds a menu item, which can then be included in any menu via the menu/menubar configuration
  editor.ui.registry.addMenuItem('orchardcoremedia', {
    text: 'Orchard Core Media Assets',
    icon: 'image',
    onAction: function () {
      // Open window
      openDialog();
    }
  });

  return {
    getMetadata: function () {
      return {
        name: "Orchard Core Media Assets",
        url: ""
      };
    }
  };
});