@using OrchardCore.Forms.Models
@model ShapeViewModel<ValidationRulePart>
@{
    var type = Model.Value.Type;
    var option = Html.Raw(Model.Value.Option);
    var formElementPart = Model.Value.ContentItem.As<FormElementPart>();
    var elementId = formElementPart.Id;
}

<script asp-src="~/OrchardCore.Forms/Scripts/validator.min.js" debug-src="~/OrchardCore.Forms/Scripts/validator.js" asp-name="validator" depends-on="jQuery" at="Foot"></script>

<script at="Foot">
    function validateElementFunction(type, originElementId, option) {
        var elementId = '#' + originElementId;
        var timestamp = new Date().getTime();
        var validateElementId = originElementId + timestamp;
        if (window.validatorObject) {
            var obj = { type: type, elementId: originElementId, option: option};
            window.validatorObject.push(obj);
        } else {
            window.validatorObject = new Array();
            var obj = { type: type, elementId: originElementId, option: option};
            window.validatorObject.push(obj);
        }
        $(elementId).bind("change keyup", function (e) {
            var re = false;
            if (window.validator.isEmpty(option)) {
                re = window.validator[type]($(elementId).val());
            } else if (window.validator.isJSON(option)) {
                re = window.validator[type]($(elementId).val(), JSON.parse(option));
            }
            else {
                re = window.validator[type]($(elementId).val(), option);
            }
            var docEle = document.getElementById(validateElementId);
            if (re) {
                if (docEle) {
                    $(elementId).parent().parent().parent().find(":submit").removeAttr('disabled');
                    docEle.remove();
                }
            } else {
                if (!docEle) {
                    var validateStr =  '@T[@type]' + ' @T["validated failed"]';
                    var dangerText = "<div id='" + validateElementId + "' class='text-danger'>" + validateStr + "</div>";
                    $(elementId).after(dangerText);
                    $(elementId).parent().parent().parent().find(":submit").attr('disabled', 'true');
                }
            }
        })
    }
    if ('@type' != "none") {
        validateElementFunction('@type', '@elementId', '@option');
    }
</script>

